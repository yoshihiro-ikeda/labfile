%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% sys:入力の.slx
% subsys:周波数応答を確認したいサブシステム(フルパス)
% filename:もしシステムで判定できていない周波数応答があれば指定して(形式はまだ決めてない)
% foldername:周波数応答結果を保存しておくファイルを指定
%function checkfrequencyresponse(sys,subsys,filename)
function getfrequencyresponse(sys,subsys,foldername)

    sysH = load_system(sys);
    
    mkdir(foldername);

    blk_list = find_system(sys,'FindAll','On','type','Block');
    blk_list_size = size(blk_list);

    inportlinelist = find_inport(subsys);
    outportlinelist = find_outport(subsys);
    
%     outportblocklist = find_system(subsys,'FindAll','On','BlockType','Outport');
%     outportblocklistsize = size(outportblocklist,1);
%     for i = 1:outportblocklistsize
%         tmpline = getfield(get_param(outportblocklist(i),'LineHandles'),'Inport');
%         tmpblock = get_param(tmpline,'Srcblockhandle');
%         outportlinelist = [outportlinelist,tmpblock];
%     end;
    
    inportlinelist_size = size(inportlinelist,2);
    outportlinelist_size = size(outportlinelist,2);
    
    disp(inportlinelist_size);
    disp(outportlinelist_size);
    
    % 入力信号変数 in_random1 を作成します
    input = frest.Random;
    % 入力の乱数ストリームは現在のグローバル ストリームとは異なるため、その状態を設定したストリームを作成して正確な再現性を確保します。
    stream = RandStream('mt19937ar','Seed',0,'NormalTransform','Ziggurat');
    %stream.State = [2358360314;652399668;37568002;3809696718;734174146;3271319781;166741401;3996949991;406887966;1666211679;2471255584;1000101879;3418933865;1080499198;414767098;2443239096;530693776;2423380572;123275169;2795562063;1585744442;1375822368;825955483;919684371;1106698687;4030962481;2044792366;3609550415;2835274026;847204337;2018343179;721630605;2649996246;3573241982;3965812771;3194700317;3967911757;3238462439;483728131;970623857;2021338386;2735008685;392953298;37626074;2694632312;2260925154;1907204186;2058547886;2752510990;857858889;291099887;936851935;2527560792;976979025;2342217385;3761671269;1587289513;4089169280;783902315;611702606;3975476451;2914743276;1190401737;676402060;462077560;3146610368;2033883970;628577536;4158583808;2032591747;60018712;347452744;987405383;4173754507;3799422501;4047904014;277668916;910740338;500011459;113735665;2960236515;1419319210;2357855584;2089545244;3140982240;1342985805;989604954;751408554;2777648746;2374057127;2434155869;331387808;1698899095;880303884;1142212219;548551038;2099034853;3339283147;1361402209;2448462124;3843630105;600532;2816816978;1547828010;705072381;2294512411;794022744;829928387;2456869163;3422811110;40593863;3334272253;23625137;1918177286;3487341942;4170539521;2063030701;287806370;823679028;2208772865;1373353201;3594474005;172227103;2450379602;3854845060;3459932586;1667326927;3398383788;3910369303;2145462521;1176428347;928443942;226805660;3802771133;810799721;3574836313;632334198;537827685;3329559046;3131416850;1410445880;1104863745;1459818598;3392058356;3375997813;1772455378;4010811787;138691145;3944874194;1795563099;2051307358;2041628209;906873438;1310089110;4000490099;1016603273;2428486721;958810097;3334963665;1918140635;1048783391;1472807549;2286678105;567224809;858858780;2144471555;529264856;1900210916;2139421814;1552641849;1805409908;1898139935;3285302837;2814660811;4104177380;1298435154;1171062660;3996876871;1925928006;3690751883;3284066738;3485989068;3822750883;2942682030;4128563435;3566349958;117216822;1712739870;592055487;1214118076;1039886271;2728215383;1009372113;719941812;1982594316;1662713344;535606910;1521781828;3789961847;724761142;2143568357;3481938789;1206302651;1357386517;2655719047;1963649666;3648000630;2775188455;2823547362;854425552;1006627669;696104140;2994646;1097067311;3502334884;1990755461;1904794340;4096538289;2422503592;2218249145;801654957;54830246;3620661387;1672535254;1099970710;4133636376;1166622238;3424966245;1697532767;3095930055;3603244978;1066945672;4182670521;297104008;3050223586;2676409237;245741602;3052649909;3811289135;2436134336;1566320311;3834358716;3910140869;284268395;1728611223;1948150782;2983378397;4075810180;3576221128;1089640731;647803372;1269937686;3290806551;3786941130;3854296763;2699091763;2026297370;3484371612;1774336717;842897234;2961992633;153967483;1572726880;12377860;964954724;555768621;4103477591;3590899592;2597178853;4094066433;3103793922;532055817;2462648914;4001783401;116812954;2394898945;1986223009;2690861101;2948437705;1914854282;2143067176;3559141921;3967442684;2905060897;3705456830;2848229965;1864233834;945505555;922117313;2763706491;127197824;2027330696;3666646579;2633449732;3534117406;1839379616;2417446631;2132098522;4503922;1309397062;3161707672;3833931017;721650246;1397677248;447156126;2935888609;2649004425;994858871;3697253460;376499245;3279676392;1748382721;2510219630;153382267;2582464034;1179172499;3244304797;1965993758;1719445349;3183137367;75121739;2177701514;1301970540;346787947;2699294590;4137693643;2590231796;3198341850;3554138137;194435375;2852821124;3830336139;1470672408;1770997357;810185989;1186759753;2355029404;559455874;2703605854;1078705658;167528219;2895404930;1281205113;870800318;2275301024;3454305413;1910242638;505890329;3299827596;539930935;3580934610;383429194;3230103667;2516825606;2170625983;494733698;1228472076;2339064092;766454185;824422520;677371304;3211011043;3881451193;1643142953;4121365330;1314426162;3474363502;2183175813;623719556;2125782273;2647812133;1806450171;1890222071;328364796;700507698;2908270228;2254805212;2070242242;3020705317;2764794382;1725970849;4116180622;713555340;3497967020;2601061130;1534476237;1652819952;2407183301;2278316621;446460915;2979130879;903284571;1222141964;2458045381;2133676638;248842469;886036872;4028437059;4254412653;90831942;3158807894;2393968563;588153416;2309030916;2999436965;2776345978;3593197280;3672772263;3937198341;1884960099;1163159036;1111273451;1642466455;903412845;2718847138;112728;850853013;2530733801;3052510846;838760960;454754467;1245182014;3253189743;1961016062;893050250;1492372372;4276834793;994761190;1143051991;1588885527;3819293709;2363278709;4264372856;2031039499;2635911893;1459648164;1451331569;4109789698;2988688976;3941248572;3879547212;1040397239;3044799767;3854629575;2230413735;3418404678;34272646;3070265937;365213020;169108641;3307360376;1113088426;2242606374;3201927272;2885191659;370782487;2257408186;157638165;2484551975;3434751968;2188287456;501652711;2980952377;3417499217;2739774434;478522330;3531394642;1435868459;3251595022;3168755657;4282752347;3638491683;1414393463;2493938876;562790051;1729622828;1378351750;3921429348;35859556;2454410504;4213041325;2488175654;3260326960;1078124833;3756367037;2908712333;3627764129;2224124240;3821767063;1213761829;1033451266;769913757;2848101986;494025262;1527759564;2884831613;2556042268;857000556;3414889797;3138602173;1437294699;3361220357;2747262393;842507868;460934012;2463896205;239207791;1246360867;1521672954;1179443972;1177725984;207655431;3080234051;3954719075;4048623945;259356041;3487977715;918815500;3665483407;2185881881;3563562323;1862464646;283486284;3501335606;2042202020;2984181950;925031108;2735195721;3017466486;3765844722;3639934354;1601699664;1667870911;1116613068;1104899520;3258899464;3856086642;1683533207;3351992381;2361285643;2303822574;2776038730;2785039639;493417230;829682757;1470589201;2374276436;2635044259;526677474;2827482554;3238267120;2093237052;763107859;2704685811;364791931;3166201733;511245893;956229734;2962230264;3529288217;3038700389;2063622600;392023524;2427157841;2507533500;1543520770;3726091769;2515190488;2704952121;1007030467;1431510767;2527883407;151413868;4228678061;3353579656;4233659910;1228286578;1185558942;1062611780;1417250484;896821006;576087664;1682090879;2918828146;1329818721;3064735500;2800405331;1478957767;1578709915;3053492688;2570063877;3121615713;3705200452;1722201423;894448804;2095912234;3675317849;1949887207;2118215332;1953065476;2183542386;2852656910;2003501532;1315677562;3211882078;3437833059;3293851327;1382144313;371670175;2189152828;4197171742;183085111;950971180;1978337477;2786717953;3941049439;1495381563;4271362397;3365086120;1831501948;3824865164;4058723437;452485287;847709685;32];
    input = set(input,...
        'Stream',stream,...
        'Ts',0.01);
    
    op = operpoint(sys);
    for i = 1:inportlinelist_size
        for j = 1:outportlinelist_size
            %周波数応答確認
            io(1) = linio(getfullname(inportlinelist(i)),1,'input');
            io(2) = linio(getfullname(outportlinelist(j)),1,'openoutput');
            sysestname = sprintf('%s/sysest_%s_%s.mat',foldername,get_param(inportlinelist(i),'name'),get_param(outportlinelist(j),'name'));
            disp(sysestname);
            %入力データを変えたかったらここの第四引数をいじってください
            %input = frest.createFixedTsSinestream(0.1);
            try
                [sysest,simout] = frestimate(sys,io,op,input);
                save(sysestname,'sysest','simout','-mat');
            catch
                disp('The frequency response of this pair can not be mesured.');
                ME = ['in:',getfullname(inportlinelist(i))];
                disp(ME);
                ME = ['out:',getfullname(outportlinelist(j))];
                disp(ME);
            end;
            %evalin(['save',sysestname,sysest]);
            %simout =
        end;
    end;
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% find_inport
% 概要：探索対象のサブシステム内から周波数応答確認の対象入力信号のリストを返す
% 入力：探索対象のサブシステム
% 出力：対象信号のリスト
% 注意：
% 
function list = find_inport(subsys)
    
    blk_list = find_system(subsys,'Findall','On','type','Block');
    blk_list_size = size(blk_list,1);
    
    correspondingblock = {'Inport' 'Constant' 'FromWorkspace'};
    returnlinelist = [];
    
    for i = 1:blk_list_size
        addflag = 0;
        disp(get_param(blk_list(i),'blocktype'))
        checklist = ismember(correspondingblock,get_param(blk_list(i),'blocktype'));
        for j = 1:size(correspondingblock,2)
            if(checklist(j))
                addflag = 1;
            end;
        end;
        if(addflag)
            %今回指定されるブロックは出力が1本しかない前提
            %tmpline = getfield(get_param(blk_list(i),'LineHandles'),'Outport');
            if strcmp(get_param(blk_list(i),'Parent'),subsys)
                returnlinelist = [returnlinelist,blk_list(i)];
            end;
        end;
    end;
    %disp(returnlinelist);
    list = returnlinelist;
end

function list = find_outport(subsys)
    
    blk_list = find_system(subsys,'Findall','On','type','Block');
    blk_list_size = size(blk_list,1);
    
    %disp(blk_list)
    
    correspondingblock = {'Outport' 'Terminator' 'ToWorkspace','Scope'};
    returnlinelist = [];
    
    for i = 1:blk_list_size
        addflag = 0;
        checklist = ismember(correspondingblock,get_param(blk_list(i),'blocktype'));
        for j = 1:size(correspondingblock,2)
            if(checklist(j))
                addflag = 1;
            end;
        end;
        if(addflag)
            %今回指定されるブロックは出力が1本しかない前提
            %tmpline = getfield(get_param(blk_list(i),'LineHandles'),'Outport');
            %disp(get_param(blk_list(i),'name'));
            if strcmp(get_param(blk_list(i),'Parent'),subsys)
                returnlinelist = [returnlinelist,blk_list(i)];
            end;
        end;
    end;
    
    outportlinelist = [];
    
    for i = 1:size(returnlinelist,2)
        tmpline = getfield(get_param(returnlinelist(i),'LineHandles'),'Inport');
        tmpblock = get_param(tmpline(1),'Srcblockhandle');
        outportlinelist = [outportlinelist,tmpblock];
    end;
    
    %disp(returnlinelist);
    list = outportlinelist;
end